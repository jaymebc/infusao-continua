<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Calculadora Cl√≠nica</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .nav-active {
            background-color: var(--input-bg) !important;
            font-weight: bold !important;
            border-left: 3px solid #3498DB !important;
        }
        .patient-sync-info {
            font-size: 12px;
            text-align: center;
            margin-top: 8px;
            min-height: 18px;
            color: #27ae60;
        }
        .calc-module-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            padding: 4px 0;
        }
        .calc-module-header h2 {
            margin: 0 !important;
            font-size: 16px !important;
        }
        .calc-module-header:hover h2 {
            color: #3498DB;
        }
        .module-toggle {
            font-size: 14px;
            color: var(--title-color);
        }
        .module-body {
            margin-top: 15px;
        }
        .module-body.module-collapsed {
            display: none;
        }
        .calc-action-bar {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--input-border);
        }
        .calc-result-span {
            background-color: var(--span-bg) !important;
            font-weight: bold !important;
            height: 37px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            max-width: 180px !important;
            padding: 8px !important;
            border: 1px solid var(--input-border) !important;
            border-radius: 8px !important;
            text-align: center !important;
            font-size: 14px !important;
            box-sizing: border-box !important;
            color: var(--text-color) !important;
        }
        .calc-result-span.updated {
            animation: pulse 0.3s ease;
        }
    </style>
</head>
<body>

<div id="overlay" class="overlay"></div>

<div id="side-menu" class="side-menu">
    <ul>
        <li id="nav-infusao">üíâ Calculadora de Infus√£o</li>
        <li id="nav-calculos" class="nav-active">üßÆ Calculadora Cl√≠nica</li>
        <li id="nav-sessao">üìã Sess√£o de Atendimento</li>
        <li id="app-info-btn">‚ÑπÔ∏è Sobre o App</li>
        <li id="dev-btn">üë®‚Äçüíª Desenvolvedor</li>
        <li id="legal-btn">‚ö†Ô∏è Aviso Legal</li>
        <li>
            üåô Modo Escuro
            <label class="switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
        </li>
    </ul>
</div>

<!-- Modal: Aviso Legal -->
<div id="legal-modal" class="modal">
    <div class="modal-content">
        <div class="close-button">
            <svg viewBox="0 0 24 24">
                <path d="M18 6L6 18" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 6L18 18" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>
        <h3>Termos de Uso e Aviso Legal</h3>
        <p><strong>CLASSIFICA√á√ÉO:</strong> Ferramenta educacional e de refer√™ncia para profissionais de sa√∫de. N√ÉO √© um dispositivo m√©dico regulamentado.</p>
        <p><strong>RESPONSABILIDADE:</strong> O usu√°rio assume TOTAL responsabilidade pela valida√ß√£o independente de todos os c√°lculos.</p>
        <p><strong>DADOS PESSOAIS:</strong> Todas as informa√ß√µes s√£o armazenadas EXCLUSIVAMENTE no dispositivo local. Este aplicativo N√ÉO transmite dados para servidores externos, em conformidade com a LGPD (Lei 13.709/2018) e CFM Resolu√ß√£o 2.217/2018.</p>
        <small>Vers√£o 2.1 | Janeiro 2026 | Dr. Jayme Castilho</small>
    </div>
</div>

<!-- Modal: Desenvolvedor -->
<div id="dev-modal" class="modal">
    <div class="modal-content">
        <div class="close-button">
            <svg viewBox="0 0 24 24">
                <path d="M18 6L6 18" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 6L18 18" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>
        <h3>Sobre o Desenvolvedor</h3>
        <p><strong>Nome:</strong> Jayme Castilho</p>
        <p><strong>Contato:</strong> <a href="mailto:chicletescerebro@gmail.com">chicletescerebro@gmail.com</a></p>
        <p><strong>Blog:</strong> <a href="https://chicletes.jaymebc.com" target="_blank">chicletes.jaymebc.com</a></p>
        <p>M√©dico anestesiologista e entusiasta de tecnologia.</p>
    </div>
</div>

<!-- Modal: Sobre o App -->
<div id="app-info-modal" class="modal">
    <div class="modal-content">
        <div class="close-button">
            <svg viewBox="0 0 24 24">
                <path d="M18 6L6 18" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 6L18 18" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>
        <h3>Sobre o App</h3>
        <p>Calculadora cl√≠nica para profissionais de anestesiologia e medicina intensiva. Inclui c√°lculos de antropometria, fun√ß√£o renal, hemodin√¢mica, hidroeletrol√≠tico e transfus√£o.</p>
        <p>Os dados do paciente s√£o sincronizados automaticamente com a Calculadora de Infus√£o.</p>
    </div>
</div>

<header>
    <button class="hamburger-menu" id="hamburger-menu">‚ò∞</button>
    <span class="header-title">
        Calculadora Cl√≠nica
        <span class="professional-badge">USO PROFISSIONAL</span>
    </span>
</header>

<div class="container">

    <!-- Dados do Paciente -->
    <div class="card">
        <h2>Dados do Paciente</h2>
        <div class="patient-data-row">
            <div class="input-group">
                <label for="weight">Peso (kg)</label>
                <input type="text" id="weight" inputmode="decimal" placeholder="Ex: 80">
                <small class="error-message" id="weight-error"></small>
            </div>
            <div class="input-group">
                <label for="height">Altura (cm)</label>
                <input type="text" id="height" inputmode="decimal" placeholder="Ex: 170">
                <small class="error-message" id="height-error"></small>
            </div>
            <div class="input-group">
                <label for="age">Idade (anos)</label>
                <input type="text" id="age" inputmode="decimal" placeholder="Ex: 45">
                <small class="error-message" id="age-error"></small>
            </div>
            <div class="input-group">
                <label for="gender">Sexo</label>
                <select id="gender">
                    <option value="">Selecione...</option>
                    <option value="M">Masculino</option>
                    <option value="F">Feminino</option>
                </select>
                <small class="error-message" id="gender-error"></small>
            </div>
        </div>
        <div id="patient-sync-info" class="patient-sync-info"></div>
    </div>

    <!-- M√≥dulo: Antropometria -->
    <div class="card">
        <div class="calc-module-header" id="header-antro">
            <h2>‚öñÔ∏è Antropometria</h2>
            <span class="module-toggle" id="toggle-antro">‚ñº</span>
        </div>
        <div class="module-body" id="body-antro">
            <div class="input-row calculator-content">
                <div class="input-column">
                    <div class="input-group-calculator">
                        <label>IMC (kg/m¬≤)</label>
                        <span class="calc-result-span" id="res-imc">-</span>
                        <small class="dose-range">Normal: 18.5 - 24.9</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Classifica√ß√£o IMC</label>
                        <span class="calc-result-span" id="res-imc-class" style="font-size:11px !important;">-</span>
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Sup. Corporal (m¬≤)</label>
                        <span class="calc-result-span" id="res-sc">-</span>
                        <small class="dose-range">DuBois | Normal: 1.6-2.0</small>
                    </div>
                </div>
                <div class="output-column">
                    <div class="input-group-calculator">
                        <label>Peso Ideal - Devine (kg)</label>
                        <span class="calc-result-span" id="res-pi">-</span>
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Peso Ajustado (kg)</label>
                        <span class="calc-result-span" id="res-pa">-</span>
                        <small class="dose-range">PI + 0.4 x (PR - PI)</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Peso Magro LBW (kg)</label>
                        <span class="calc-result-span" id="res-lbw">-</span>
                        <small class="dose-range">Janmahasatian</small>
                    </div>
                </div>
            </div>
            <div class="calc-action-bar">
                <button class="export-btn export-btn-save" id="btn-session-antro">üìã Adicionar √† sess√£o</button>
            </div>
        </div>
    </div>

    <!-- M√≥dulo: Fun√ß√£o Renal -->
    <div class="card">
        <div class="calc-module-header" id="header-renal">
            <h2>ü´ò Fun√ß√£o Renal</h2>
            <span class="module-toggle" id="toggle-renal">‚ñº</span>
        </div>
        <div class="module-body" id="body-renal">
            <div class="input-row calculator-content">
                <div class="input-column">
                    <div class="input-group-calculator">
                        <label for="creatinina">Creatinina (mg/dL)</label>
                        <input type="text" id="creatinina" inputmode="decimal" placeholder="Ex: 1.0">
                        <small class="dose-range">Normal: 0.6 - 1.2</small>
                    </div>
                </div>
                <div class="output-column">
                    <div class="input-group-calculator">
                        <label>Cockcroft-Gault (mL/min)</label>
                        <span class="calc-result-span" id="res-cg">-</span>
                        <small class="dose-range">Normal: &gt; 90</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>CKD-EPI (mL/min/1.73m¬≤)</label>
                        <span class="calc-result-span" id="res-ckdepi">-</span>
                        <small class="dose-range">Normal: &gt; 60</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Estadio DRC</label>
                        <span class="calc-result-span" id="res-drc" style="font-size:11px !important;">-</span>
                        <small class="dose-range">&nbsp;</small>
                    </div>
                </div>
            </div>
            <div class="calc-action-bar">
                <button class="export-btn export-btn-save" id="btn-session-renal">üìã Adicionar √† sess√£o</button>
            </div>
        </div>
    </div>

    <!-- M√≥dulo: Hemodin√¢mica -->
    <div class="card">
        <div class="calc-module-header" id="header-hemo">
            <h2>‚ù§Ô∏è Hemodin√¢mica</h2>
            <span class="module-toggle" id="toggle-hemo">‚ñº</span>
        </div>
        <div class="module-body" id="body-hemo">
            <div class="input-row calculator-content">
                <div class="input-column">
                    <div class="input-group-calculator">
                        <label for="pas">PAS (mmHg)</label>
                        <input type="text" id="pas" inputmode="decimal" placeholder="Ex: 120">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="pad">PAD (mmHg)</label>
                        <input type="text" id="pad" inputmode="decimal" placeholder="Ex: 80">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="pvc">PVC (mmHg)</label>
                        <input type="text" id="pvc" inputmode="decimal" placeholder="Ex: 8">
                        <small class="dose-range">Normal: 2 - 8</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="fc">FC (bpm)</label>
                        <input type="text" id="fc" inputmode="decimal" placeholder="Ex: 70">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="vs-input">Vol. Sist√≥lico (mL)</label>
                        <input type="text" id="vs-input" inputmode="decimal" placeholder="Ex: 70">
                        <small class="dose-range">Normal: 50 - 100</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="hemoglobina">Hemoglobina (g/dL)</label>
                        <input type="text" id="hemoglobina" inputmode="decimal" placeholder="Ex: 14">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="sao2">SaO2 (%)</label>
                        <input type="text" id="sao2" inputmode="decimal" placeholder="Ex: 98">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="pao2">PaO2 (mmHg)</label>
                        <input type="text" id="pao2" inputmode="decimal" placeholder="Ex: 100">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="svo2">SvO2 (%)</label>
                        <input type="text" id="svo2" inputmode="decimal" placeholder="Ex: 75">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="pvo2">PvO2 (mmHg)</label>
                        <input type="text" id="pvo2" inputmode="decimal" placeholder="Ex: 40">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                </div>
                <div class="output-column">
                    <div class="input-group-calculator">
                        <label>PAM (mmHg)</label>
                        <span class="calc-result-span" id="res-pam">-</span>
                        <small class="dose-range">Normal: 70 - 100</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>PP (mmHg)</label>
                        <span class="calc-result-span" id="res-pp">-</span>
                        <small class="dose-range">Normal: 40 - 60</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>DC - Fick (L/min)</label>
                        <span class="calc-result-span" id="res-dc">-</span>
                        <small class="dose-range">Normal: 4.0 - 8.0</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>DC - FC x VS (L/min)</label>
                        <span class="calc-result-span" id="res-dc2">-</span>
                        <small class="dose-range">Normal: 4.0 - 8.0</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>IC (L/min/m¬≤)</label>
                        <span class="calc-result-span" id="res-ic">-</span>
                        <small class="dose-range">Normal: 2.5 - 4.0</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>RVS (dyn.s/cm‚Åµ)</label>
                        <span class="calc-result-span" id="res-rvs">-</span>
                        <small class="dose-range">Normal: 900 - 1440</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>IRVS (dyn.s/cm‚Åµ.m¬≤)</label>
                        <span class="calc-result-span" id="res-irvs">-</span>
                        <small class="dose-range">Normal: 1700 - 2400</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>CaO2 (mL/L)</label>
                        <span class="calc-result-span" id="res-cao2">-</span>
                        <small class="dose-range">Normal: 160 - 200</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>CvO2 (mL/L)</label>
                        <span class="calc-result-span" id="res-cvo2">-</span>
                        <small class="dose-range">Normal: 120 - 150</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>VO2 estimado (mL/min)</label>
                        <span class="calc-result-span" id="res-vo2">-</span>
                        <small class="dose-range">Normal: 200 - 300</small>
                    </div>
                </div>
            </div>
            <div class="calc-action-bar">
                <button class="export-btn export-btn-save" id="btn-session-hemo">üìã Adicionar √† sess√£o</button>
            </div>
        </div>
    </div>

    <!-- M√≥dulo: Hidroeletrol√≠tico -->
    <div class="card">
        <div class="calc-module-header" id="header-hidro">
            <h2>üíß Hidroeletrol√≠tico</h2>
            <span class="module-toggle" id="toggle-hidro">‚ñº</span>
        </div>
        <div class="module-body" id="body-hidro">
            <div class="input-row calculator-content">
                <div class="input-column">
                    <div class="input-group-calculator">
                        <label for="na-atual">Na+ atual (mEq/L)</label>
                        <input type="text" id="na-atual" inputmode="decimal" placeholder="Ex: 130">
                        <small class="dose-range">Normal: 135 - 145</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="na-alvo">Na+ alvo (mEq/L)</label>
                        <input type="text" id="na-alvo" inputmode="decimal" placeholder="Ex: 140" value="140">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="glicose">Glicose (mg/dL)</label>
                        <input type="text" id="glicose" inputmode="decimal" placeholder="Ex: 90">
                        <small class="dose-range">Normal: 70 - 100</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="ureia">Ureia (mg/dL)</label>
                        <input type="text" id="ureia" inputmode="decimal" placeholder="Ex: 30">
                        <small class="dose-range">Normal: 10 - 45</small>
                    </div>
                </div>
                <div class="output-column">
                    <div class="input-group-calculator">
                        <label>D√©ficit de Na+ (mEq)</label>
                        <span class="calc-result-span" id="res-deficit-na">-</span>
                        <small class="dose-range">0.6 x Peso x (Alvo - Atual)</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Excesso √Ågua Livre (mL)</label>
                        <span class="calc-result-span" id="res-agua-livre">-</span>
                        <small class="dose-range">Se Na+ &gt; 145</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>D√©ficit √Ågua Livre (mL)</label>
                        <span class="calc-result-span" id="res-deficit-agua">-</span>
                        <small class="dose-range">Se Na+ &lt; 135</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Osmolaridade (mOsm/L)</label>
                        <span class="calc-result-span" id="res-osm">-</span>
                        <small class="dose-range">Normal: 285 - 295</small>
                    </div>
                </div>
            </div>
            <div class="calc-action-bar">
                <button class="export-btn export-btn-save" id="btn-session-hidro">üìã Adicionar √† sess√£o</button>
            </div>
        </div>
    </div>

    <!-- M√≥dulo: Transfus√£o -->
    <div class="card">
        <div class="calc-module-header" id="header-transf">
            <h2>ü©∏ Transfus√£o</h2>
            <span class="module-toggle" id="toggle-transf">‚ñº</span>
        </div>
        <div class="module-body" id="body-transf">
            <div class="input-row calculator-content">
                <div class="input-column">
                    <div class="input-group-calculator">
                        <label for="hb-atual">Hb atual (g/dL)</label>
                        <input type="text" id="hb-atual" inputmode="decimal" placeholder="Ex: 10">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="ht-inicial">Ht inicial (%)</label>
                        <input type="text" id="ht-inicial" inputmode="decimal" placeholder="Ex: 40">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="ht-minimo">Ht m√≠nimo aceit√°vel (%)</label>
                        <input type="text" id="ht-minimo" inputmode="decimal" placeholder="Ex: 24">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label for="hb-alvo">Hb alvo (g/dL)</label>
                        <input type="text" id="hb-alvo" inputmode="decimal" placeholder="Ex: 10" value="10">
                        <small class="dose-range">&nbsp;</small>
                    </div>
                </div>
                <div class="output-column">
                    <div class="input-group-calculator">
                        <label>Vol. Sangu√≠neo Est. (mL)</label>
                        <span class="calc-result-span" id="res-vse">-</span>
                        <small class="dose-range">H: 70 mL/kg | M: 65 mL/kg</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Perda M√°x. Tolerada (mL)</label>
                        <span class="calc-result-span" id="res-pmt">-</span>
                        <small class="dose-range">&nbsp;</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>CH necess√°rios (unid.)</label>
                        <span class="calc-result-span" id="res-ch">-</span>
                        <small class="dose-range">D√©ficit Hb x Peso x 0.3</small>
                    </div>
                    <div class="input-group-calculator">
                        <label>Plaquetas (unid.)</label>
                        <span class="calc-result-span" id="res-plaq">-</span>
                        <small class="dose-range">1 unid / 10 kg</small>
                    </div>
                </div>
            </div>
            <div class="calc-action-bar">
                <button class="export-btn export-btn-save" id="btn-session-transf">üìã Adicionar √† sess√£o</button>
            </div>
        </div>
    </div>

</div>

<footer>JBC Inform√°tica | 2026</footer>

<script>
(function() {

    // ‚îÄ‚îÄ‚îÄ HELPERS 
    function byId(id) { return document.getElementById(id); }

    function sanitize(input) {
        var pos = input.selectionStart;
        var original = input.value;
        var cleaned = original.replace(/,/g, '.').replace(/[^0-9.]/g, '');
        var parts = cleaned.split('.');
        if (parts.length > 2) cleaned = parts[0] + '.' + parts.slice(1).join('');
        if (parts.length === 2 && parts[1].length > 2) cleaned = parts[0] + '.' + parts[1].substring(0, 2);
        if (cleaned !== original) {
            input.value = cleaned;
            if (pos > 0) {
                try { input.setSelectionRange(pos - 1, pos - 1); } catch(e) {}
            }
        }
    }

    function v(id) {
        var el = byId(id);
        if (!el) return 0;
        return parseFloat(el.value.replace(',', '.')) || 0;
    }

    function setR(id, value, dec) {
        var el = byId(id);
        if (!el) return;
        if (value === null || value === undefined || isNaN(value) || !isFinite(value)) {
            el.textContent = '-'; return;
        }
        var d = (dec === undefined) ? 2 : dec;
        el.textContent = value.toFixed(d);
        el.classList.add('updated');
        setTimeout(function() { el.classList.remove('updated'); }, 300);
    }

    function setT(id, text) {
        var el = byId(id);
        if (el) el.textContent = (text || '-');
    }

    function txt(id) {
        var el = byId(id);
        return el ? el.textContent : '-';
    }

    // ‚îÄ‚îÄ‚îÄ C√ÅLCULOS 
    function calcAntro() {
        var peso   = v('weight');
        var altura = v('height');
        var sexo   = byId('gender').value;
        if (!peso || !altura) {
            ['res-imc','res-imc-class','res-sc','res-pi','res-pa','res-lbw'].forEach(function(id){ setT(id,'-'); });
            return;
        }
        var altM = altura / 100;
        var imc  = peso / (altM * altM);
        setR('res-imc', imc, 1);
        var cls = '';
        if (imc < 18.5)     cls = 'Abaixo do peso';
        else if (imc < 25)  cls = 'Peso normal';
        else if (imc < 30)  cls = 'Sobrepeso';
        else if (imc < 35)  cls = 'Obesidade I';
        else if (imc < 40)  cls = 'Obesidade II';
        else                cls = 'Obesidade III';
        setT('res-imc-class', cls);
        var sc = 0.007184 * Math.pow(altura, 0.725) * Math.pow(peso, 0.425);
        setR('res-sc', sc, 2);
        var pi = 0;
        if (sexo === 'M')      pi = 50   + 2.3 * ((altura - 152.4) / 2.54);
        else if (sexo === 'F') pi = 45.5  + 2.3 * ((altura - 152.4) / 2.54);
        if (pi > 0) {
            setR('res-pi', pi, 1);
            setR('res-pa', imc > 30 ? pi + 0.4 * (peso - pi) : null, 1);
            if (imc <= 30) setT('res-pa', 'IMC <= 30');
            var lbw = sexo === 'M' ? (9270 * peso) / (6680 + 216 * imc) : (9270 * peso) / (8780 + 244 * imc);
            setR('res-lbw', lbw, 1);
        } else {
            setT('res-pi', 'Informe o sexo');
            setT('res-pa', '-');
            setT('res-lbw', 'Informe o sexo');
        }
    }

    function calcRenal() {
        var peso  = v('weight');
        var idade = v('age');
        var sexo  = byId('gender').value;
        var creat = v('creatinina');
        if (!creat || !peso || !idade || !sexo) {
            setT('res-cg','-'); setT('res-ckdepi','-'); setT('res-drc','-'); return;
        }
        var cg = ((140 - idade) * peso) / (72 * creat);
        if (sexo === 'F') cg *= 0.85;
        setR('res-cg', cg, 1);
        var k = sexo === 'F' ? 0.7 : 0.9;
        var a = sexo === 'F' ? -0.241 : -0.302;
        var ratio = creat / k;
        var epi = ratio < 1 ?
            142 * Math.pow(ratio, a) * Math.pow(0.9938, idade) :
            142 * Math.pow(ratio, -1.200) * Math.pow(0.9938, idade);
        if (sexo === 'F') epi *= 1.012;
        setR('res-ckdepi', epi, 1);
        var est = '';
        if (epi >= 90)      est = 'G1 - Normal (>= 90)';
        else if (epi >= 60) est = 'G2 - Lev. reduzido';
        else if (epi >= 45) est = 'G3a - Mod. reduzido';
        else if (epi >= 30) est = 'G3b - Mod. severo';
        else if (epi >= 15) est = 'G4 - Sev. reduzido';
        else                est = 'G5 - Falencia renal';
        setT('res-drc', est);
    }

    function calcHemo() {
        var pas  = v('pas');  var pad  = v('pad');  var pvc = v('pvc');
        var fc   = v('fc');   var vsI  = v('vs-input');
        var hb   = v('hemoglobina');
        var sao2 = v('sao2'); var pao2 = v('pao2');
        var svo2 = v('svo2'); var pvo2 = v('pvo2');
        var peso = v('weight'); var alt = v('height');
        var sc   = (alt && peso) ? 0.007184 * Math.pow(alt, 0.725) * Math.pow(peso, 0.425) : 0;
        var pam  = (pas && pad) ? (pas + 2 * pad) / 3 : null;
        pam !== null ? setR('res-pam', pam, 1) : setT('res-pam','-');
        (pas && pad) ? setR('res-pp', pas - pad, 0) : setT('res-pp','-');
        var cao2 = (hb && sao2) ? (hb * 13.4 * (sao2/100)) + (pao2 * 0.0031) : null;
        var cvo2 = (hb && svo2) ? (hb * 13.4 * (svo2/100)) + (pvo2 * 0.0031) : null;
        cao2 !== null ? setR('res-cao2', cao2, 2) : setT('res-cao2','-');
        cvo2 !== null ? setR('res-cvo2', cvo2, 2) : setT('res-cvo2','-');
        var vo2 = sc ? 125 * sc : null;
        vo2 ? setR('res-vo2', vo2, 1) : setT('res-vo2','-');
        var dc = (cao2 && cvo2 && vo2 && cao2 > cvo2) ? vo2 / (cao2 - cvo2) : null;
        dc !== null ? setR('res-dc', dc, 2) : setT('res-dc','-');
        var dc2 = (fc && vsI) ? (fc * vsI) / 1000 : null;
        dc2 !== null ? setR('res-dc2', dc2, 2) : setT('res-dc2','-');
        var dcu = dc !== null ? dc : dc2;
        (dcu && sc) ? setR('res-ic', dcu / sc, 2) : setT('res-ic','-');
        if (dcu && pam !== null) {
            var rvs = 80 * (pam - pvc) / dcu;
            setR('res-rvs', rvs, 0);
            sc ? setR('res-irvs', rvs * sc, 0) : setT('res-irvs','-');
        } else { setT('res-rvs','-'); setT('res-irvs','-'); }
    }

    function calcHidro() {
        var peso   = v('weight');
        var naAt   = v('na-atual');
        var naAlvo = v('na-alvo');
        var glic   = v('glicose');
        var ureia  = v('ureia');
        var sexo   = byId('gender').value;
        if (!peso) {
            ['res-deficit-na','res-agua-livre','res-deficit-agua','res-osm'].forEach(function(id){ setT(id,'-'); });
            return;
        }
        var fat = sexo === 'F' ? 0.5 : 0.6;
        var act = fat * peso;
        (naAt && naAlvo) ? setR('res-deficit-na', fat * peso * (naAlvo - naAt), 1) : setT('res-deficit-na','-');
        (naAt && naAt > 145) ? setR('res-agua-livre', act * (naAt/140 - 1) * 1000, 0) : setT('res-agua-livre','-');
        (naAt && naAt < 135) ? setR('res-deficit-agua', act * (1 - naAt/140) * 1000, 0) : setT('res-deficit-agua','-');
        (naAt && glic && ureia) ? setR('res-osm', 2*naAt + glic/18 + ureia/6, 1) : setT('res-osm','-');
    }

    function calcTransf() {
        var peso   = v('weight');
        var hbAt   = v('hb-atual');
        var htIni  = v('ht-inicial');
        var htMin  = v('ht-minimo');
        var hbAlvo = v('hb-alvo');
        var sexo   = byId('gender').value;
        if (!peso) {
            ['res-vse','res-pmt','res-ch','res-plaq'].forEach(function(id){ setT(id,'-'); });
            return;
        }
        var vse = peso * (sexo === 'F' ? 65 : 70);
        setR('res-vse', vse, 0);
        if (htIni && htMin) {
            setR('res-pmt', vse * (htIni - htMin) / ((htIni + htMin) / 2), 0);
        } else setT('res-pmt','-');
        if (hbAt && hbAlvo) {
            var def = hbAlvo - hbAt;
            def > 0 ? setR('res-ch', (def * peso * 0.3) / 50, 1) : setT('res-ch','Hb acima do alvo');
        } else setT('res-ch','-');
        setR('res-plaq', peso / 10, 1);
    }

    function recalcAll() {
        calcAntro(); calcRenal(); calcHemo(); calcHidro(); calcTransf();
    }

    // ‚îÄ‚îÄ‚îÄ PACIENTE 
    function loadPatientData() {
        try {
            var saved = localStorage.getItem('patientData');
            if (!saved) return;
            var d = JSON.parse(saved);
            if (d.weight) byId('weight').value = d.weight;
            if (d.height) byId('height').value = d.height;
            if (d.age)    byId('age').value    = d.age;
            if (d.gender) byId('gender').value = d.gender;
            var info = byId('patient-sync-info');
            if (info) info.textContent = 'Dados sincronizados da Calculadora de Infus√£o';
        } catch(e) {}
        recalcAll();
    }

    function savePatientData() {
        try {
            localStorage.setItem('patientData', JSON.stringify({
                weight: byId('weight').value,
                height: byId('height').value,
                age:    byId('age').value,
                gender: byId('gender').value
            }));
        } catch(e) {}
    }

    // ‚îÄ‚îÄ‚îÄ SESS√ÉO 
    function addToSession(moduleName, results, btnId) {
        var valid = results.filter(function(r){ return r.value !== '-' && r.value !== ''; });
        if (valid.length === 0) { alert('Nenhum resultado disponivel para adicionar.'); return; }
        try {
            var session = {};
            try { session = JSON.parse(localStorage.getItem('sessionData')) || {}; } catch(e) {}
            if (!session.calcs) session.calcs = [];
            if (!session.drugs) session.drugs = [];
            session.calcs.push({ id: Date.now(), timestamp: new Date().toISOString(), module: moduleName, weight: byId('weight').value, results: valid });
            localStorage.setItem('sessionData', JSON.stringify(session));
            var btn = byId(btnId);
            if (btn) {
                var orig = btn.textContent;
                btn.textContent = '‚úÖ Adicionado!';
                btn.disabled = true;
                setTimeout(function(){ btn.textContent = orig; btn.disabled = false; }, 2000);
            }
        } catch(e) { alert('Erro ao adicionar a sessao.'); }
    }

    // ‚îÄ‚îÄ‚îÄ DARK MODE 
    function applyDarkMode(isDark) {
        document.body.classList.toggle('dark-mode', isDark);
        var tog = byId('darkModeToggle');
        if (tog) tog.checked = isDark;
    }

    // ‚îÄ‚îÄ‚îÄ INIT 
    document.addEventListener('DOMContentLoaded', function() {

        // Menu
        var hamburger  = byId('hamburger-menu');
        var sideMenu   = byId('side-menu');
        var overlay    = byId('overlay');

        function toggleMenu() {
            sideMenu.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function openModal(modal) {
            if (modal) modal.style.display = 'block';
            if (sideMenu.classList.contains('open')) toggleMenu();
        }

        hamburger.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);

        var navInfusao = byId('nav-infusao');
        var navSessao  = byId('nav-sessao');
        if (navInfusao) navInfusao.addEventListener('click', function(){ window.location.href = 'index.html'; });
        if (navSessao)  navSessao.addEventListener('click',  function(){ window.location.href = 'sessao.html'; });

        var legalBtn   = byId('legal-btn');
        var devBtn     = byId('dev-btn');
        var appInfoBtn = byId('app-info-btn');
        if (legalBtn)   legalBtn.addEventListener('click',   function(){ openModal(byId('legal-modal')); });
        if (devBtn)     devBtn.addEventListener('click',     function(){ openModal(byId('dev-modal')); });
        if (appInfoBtn) appInfoBtn.addEventListener('click', function(){ openModal(byId('app-info-modal')); });

        document.querySelectorAll('.close-button').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                var modal = e.currentTarget.closest('.modal');
                if (modal) modal.style.display = 'none';
            });
        });

        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        });

        var darkToggle = byId('darkModeToggle');
        if (darkToggle) {
            darkToggle.addEventListener('change', function() {
                localStorage.setItem('darkMode', darkToggle.checked);
                applyDarkMode(darkToggle.checked);
            });
        }
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var savedTheme  = localStorage.getItem('darkMode');
        applyDarkMode(savedTheme === 'true' || (savedTheme === null && prefersDark));

        // M√≥dulos colaps√°veis
        ['antro','renal','hemo','hidro','transf'].forEach(function(m) {
            var header = byId('header-' + m);
            if (!header) return;
            header.addEventListener('click', function() {
                var body   = byId('body-' + m);
                var toggle = byId('toggle-' + m);
                if (!body) return;
                if (body.classList.contains('module-collapsed')) {
                    body.classList.remove('module-collapsed');
                    if (toggle) toggle.textContent = '‚ñº';
                } else {
                    body.classList.add('module-collapsed');
                    if (toggle) toggle.textContent = '‚ñ∂';
                }
            });
        });

        // Inputs paciente ‚Äî sanitize + recalc
        ['weight','height','age'].forEach(function(id) {
            var el = byId(id);
            if (!el) return;
            el.addEventListener('keypress', function(e) {
                var char = String.fromCharCode(e.which || e.keyCode);
                if (!/[0-9.]/.test(char)) { e.preventDefault(); return; }
                if (char === '.' && el.value.indexOf('.') !== -1) { e.preventDefault(); }
            });
            el.addEventListener('input', function() {
                sanitize(el);
                savePatientData();
                recalcAll();
            });
        });

        byId('gender').addEventListener('change', function() {
            savePatientData();
            recalcAll();
        });

        // Inputs dos m√≥dulos ‚Äî sanitize + recalc
        ['creatinina','pas','pad','pvc','fc','vs-input',
         'hemoglobina','sao2','pao2','svo2','pvo2',
         'na-atual','na-alvo','glicose','ureia',
         'hb-atual','ht-inicial','ht-minimo','hb-alvo'].forEach(function(id) {
            var el = byId(id);
            if (!el) return;
            el.addEventListener('keypress', function(e) {
                var char = String.fromCharCode(e.which || e.keyCode);
                if (!/[0-9.]/.test(char)) { e.preventDefault(); return; }
                if (char === '.' && el.value.indexOf('.') !== -1) { e.preventDefault(); }
            });
            el.addEventListener('input', function() {
                sanitize(el);
                recalcAll();
            });
        });

        // Bot√µes sess√£o
        byId('btn-session-antro').addEventListener('click', function() {
            addToSession('Antropometria', [
                {label:'IMC (kg/m2)',          value: txt('res-imc')},
                {label:'Classificacao IMC',     value: txt('res-imc-class')},
                {label:'Sup. Corporal (m2)',    value: txt('res-sc')},
                {label:'Peso Ideal (kg)',        value: txt('res-pi')},
                {label:'Peso Ajustado (kg)',     value: txt('res-pa')},
                {label:'Peso Magro LBW (kg)',    value: txt('res-lbw')}
            ], 'btn-session-antro');
        });

        byId('btn-session-renal').addEventListener('click', function() {
            addToSession('Funcao Renal', [
                {label:'Creatinina (mg/dL)',       value: byId('creatinina').value},
                {label:'Cockcroft-Gault (mL/min)', value: txt('res-cg')},
                {label:'CKD-EPI (mL/min/1.73m2)',  value: txt('res-ckdepi')},
                {label:'Estadio DRC',              value: txt('res-drc')}
            ], 'btn-session-renal');
        });

        byId('btn-session-hemo').addEventListener('click', function() {
            addToSession('Hemodinamica', [
                {label:'PAM (mmHg)',             value: txt('res-pam')},
                {label:'PP (mmHg)',              value: txt('res-pp')},
                {label:'DC Fick (L/min)',         value: txt('res-dc')},
                {label:'DC FC x VS (L/min)',      value: txt('res-dc2')},
                {label:'IC (L/min/m2)',           value: txt('res-ic')},
                {label:'RVS (dyn.s/cm5)',         value: txt('res-rvs')},
                {label:'IRVS (dyn.s/cm5.m2)',     value: txt('res-irvs')},
                {label:'CaO2 (mL/L)',             value: txt('res-cao2')},
                {label:'CvO2 (mL/L)',             value: txt('res-cvo2')},
                {label:'VO2 estimado (mL/min)',   value: txt('res-vo2')}
            ], 'btn-session-hemo');
        });

        byId('btn-session-hidro').addEventListener('click', function() {
            addToSession('Hidroeletrolitico', [
                {label:'Deficit Na+ (mEq)',       value: txt('res-deficit-na')},
                {label:'Excesso Agua Livre (mL)', value: txt('res-agua-livre')},
                {label:'Deficit Agua Livre (mL)', value: txt('res-deficit-agua')},
                {label:'Osmolaridade (mOsm/L)',   value: txt('res-osm')}
            ], 'btn-session-hidro');
        });

        byId('btn-session-transf').addEventListener('click', function() {
            addToSession('Transfusao', [
                {label:'Vol. Sanguineo Est. (mL)', value: txt('res-vse')},
                {label:'Perda Max. Tolerada (mL)', value: txt('res-pmt')},
                {label:'CH necessarios (unid.)',   value: txt('res-ch')},
                {label:'Plaquetas (unid.)',         value: txt('res-plaq')}
            ], 'btn-session-transf');
        });

        // Carregar dados do paciente e calcular
        loadPatientData();
    });

})();
</script>

</body>
</html>